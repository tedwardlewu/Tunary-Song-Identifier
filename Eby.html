<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tunary</title>
    <link rel="icon" type="image/png" href="Tunary.png">
    <link rel="stylesheet" href="Eby.css">
</head>

<body>

<div class="container">
    <img src="Tunary.png" class="logo">

    <h1>Song Identifier</h1>

    <button id="recordBtn" class="record-btn">Start Recording</button>

    <progress id="recordProgress" value="0" max="100" class="progress"></progress>

    <audio id="audioPlayback" controls></audio>

    <div class="result" id="result"></div>
</div>

<script>
let mediaRecorder;
let audioChunks = [];
let isRecording = false;
const MAX_RECORD_TIME = 10;

const recordBtn = document.getElementById('recordBtn');
const audioPlayback = document.getElementById('audioPlayback');
const resultDiv = document.getElementById('result');
const recordProgress = document.getElementById('recordProgress');

recordBtn.onclick = async () => {

    if (!isRecording) startRecording();

    else stopRecording();
};

async function startRecording() {
    audioChunks = [];
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.start();
    isRecording = true;
    recordBtn.textContent = "â¹ Stop Recording";
    recordBtn.classList.add("recording");

    resultDiv.textContent = "";
    audioPlayback.style.display = "none";
    recordProgress.style.display = "block";
    recordProgress.value = 0;

    let startTime = Date.now();
    const progressInterval = setInterval(() => {

        let elapsed = (Date.now() - startTime) / 1000;
        recordProgress.value = (elapsed / MAX_RECORD_TIME) * 100;

        if (elapsed >= MAX_RECORD_TIME) stopRecording();
    }, 50);

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = () => processAudio(progressInterval);
}

function stopRecording() {

    if (!isRecording) return;
    mediaRecorder.stop();
    isRecording = false;
    recordBtn.textContent = "Start Recording";
    recordBtn.classList.remove("recording");
    recordProgress.style.display = "none";
}

async function processAudio(progressInterval) {
    clearInterval(progressInterval);

    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
    audioPlayback.src = URL.createObjectURL(audioBlob);
    audioPlayback.style.display = "block";

    resultDiv.textContent = "Identifying song...";

    const formData = new FormData();
    formData.append('file', audioBlob, 'recording.wav');
    formData.append('api_token', "bdd6fde27d83e28c3e1507fda278ff6d");
    formData.append('return', 'apple_music,spotify');

    try {
        const response = await fetch("https://api.audd.io/", { method: 'POST', body: formData });
        const data = await response.json();

        resultDiv.innerHTML = data?.result ? formatSongInfo(data.result) : "Song not found. Try again.";
    } catch {
        resultDiv.textContent = "Error identifying song.";
    }
}

function formatSongInfo(s) {
    return `
        <div class="song-info">
            ðŸŽ¶ <b>${s.title}</b><br>
            ðŸ‘¤ ${s.artist}<br>
            ${s.album ? `ðŸ’¿ ${s.album}<br>` : ""}
            ${s.release_date ? `ðŸ“… ${s.release_date}<br>` : ""}
            ${s.spotify?.external_urls?.spotify ? `<a href="${s.spotify.external_urls.spotify}" target="_blank">Spotify</a><br>` : ""}
            ${s.apple_music?.url ? `<a href="${s.apple_music.url}" target="_blank">Apple Music</a>` : ""}
        </div>
    `;
}
</script>

</body>
</html>
